# Система автоматического мониторинга и алертов для метрик

## Описание проекта

Проект реализует автоматическую систему мониторинга пользовательских метрик и отправки уведомлений в Telegram при обнаружении аномалий. Скрипт работает в Airflow с периодичностью 15 минут и отслеживает следующие метрики:

- Количество уникальных пользователей (`users_feed`)
- Просмотры (`views`)
- Лайки (`likes`)

При обнаружении аномального значения формируется сообщение и график с визуализацией метрики и границ отклонения, которые отправляются в Telegram.

## Источник данных

Данные берутся из ClickHouse за последние 24 часа с агрегацией по 15-минутным интервалам:

- `users_feed` — количество уникальных пользователей
- `likes` — количество лайков
- `views` — количество просмотров

## Алгоритм обнаружения аномалий

Аномалии определяются по межквартильному размаху (IQR) со следующими шагами:

1. Вычисление Q1 (25%) и Q3 (75%) по скользящему окну
2. Расчёт границ: `low = Q1 - a * IQR`, `up = Q3 + a * IQR` (по умолчанию `a = 3`, `n = 5`)
3. Сглаживание границ и проверка последнего значения на выход за пределы диапазона

Если обнаружено отклонение, система:

- Отправляет текстовое сообщение с текущим значением и разницей от предыдущего
- Строит и отправляет график с историей метрики, верхней и нижней границами

## Используемые технологии

- **Python 3**
- **Apache Airflow** — запуск DAG каждые 15 минут
- **ClickHouse + pandahouse** — источник данных
- **matplotlib / seaborn** — построение графиков
- **telegram** — отправка сообщений и изображений
- **Pandas / NumPy** — обработка данных

## Пример графика

Пример визуализации отправляется в Telegram при каждом обнаружении аномалии. График содержит:

- Значения метрики
- Верхнюю и нижнюю границу отклонения
- Подписи времени (с интервалом)

## Как работает

1. DAG запускается каждые 15 минут
2. Из базы данных извлекаются метрики за последние сутки
3. Проверяется наличие аномалий
4. В случае отклонения:
   - Генерируется сообщение
   - Строится график
   - Всё отправляется в Telegram

## Файл

- `alert_sender.py` — основной скрипт


